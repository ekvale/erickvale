{% extends 'activity_media/base.html' %}
{% load static %}

{% block title %}Media Map - Activity Media{% endblock %}

{% block extra_css %}
<style>
    #map {
        height: 600px;
        width: 100%;
        border-radius: 8px;
    }
    .map-filters {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="mb-4">Media Map</h1>
        
        <!-- Filters -->
        <div class="map-filters">
            <form method="get" class="row g-3">
                <div class="col-md-4">
                    <label for="tag" class="form-label">Filter by Activity Tag</label>
                    <select class="form-select" id="tag" name="tag" onchange="this.form.submit()">
                        <option value="">All Tags</option>
                        {% for tag in all_tags %}
                            <option value="{{ tag.name }}" {% if tag_filter == tag.name %}selected{% endif %}>
                                {{ tag.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="type" class="form-label">Filter by Media Type</label>
                    <select class="form-select" id="type" name="type" onchange="this.form.submit()">
                        <option value="">All Types</option>
                        <option value="photo" {% if media_type_filter == 'photo' %}selected{% endif %}>Photos</option>
                        <option value="video" {% if media_type_filter == 'video' %}selected{% endif %}>Videos</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">&nbsp;</label>
                    <a href="{% url 'activity_media:map' %}" class="btn btn-secondary w-100">Clear Filters</a>
                </div>
            </form>
        </div>
        
        <!-- Map -->
        <div id="map"></div>
        
        <div class="mt-3">
            <a href="{% url 'activity_media:list' %}" class="btn btn-secondary">Back to List</a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize map
    const mapData = {{ map_data|safe }};
    
    // Create map centered on first item or default location
    let mapCenter = [44.9778, -93.2650]; // Default: Minneapolis
    let mapZoom = 6;
    
    if (mapData.length > 0) {
        // Center on first item or average of all items
        const avgLat = mapData.reduce((sum, item) => sum + item.lat, 0) / mapData.length;
        const avgLon = mapData.reduce((sum, item) => sum + item.lon, 0) / mapData.length;
        mapCenter = [avgLat, avgLon];
        mapZoom = 10;
    }
    
    const map = L.map('map').setView(mapCenter, mapZoom);
    
    // Add tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);
    
    // Create marker cluster group
    const markers = L.markerClusterGroup();
    
    // Add markers for each media item
    mapData.forEach(function(item) {
        const icon = L.divIcon({
            className: 'custom-marker',
            html: `<div style="background: ${item.type === 'photo' ? '#28a745' : '#dc3545'}; 
                              color: white; 
                              border-radius: 50%; 
                              width: 30px; 
                              height: 30px; 
                              display: flex; 
                              align-items: center; 
                              justify-content: center;
                              border: 2px solid white;
                              box-shadow: 0 2px 4px rgba(0,0,0,0.3);">
                      ${item.type === 'photo' ? 'ðŸ“·' : 'ðŸŽ¥'}
                   </div>`,
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        });
        
        const marker = L.marker([item.lat, item.lon], {icon: icon});
        
        let popupContent = `
            <div style="min-width: 200px;">
                <h6><a href="${item.url}">${item.title}</a></h6>
                <p class="mb-1"><strong>Type:</strong> ${item.type}</p>
        `;
        
        if (item.location_name) {
            popupContent += `<p class="mb-1"><strong>Location:</strong> ${item.location_name}</p>`;
        }
        
        if (item.tags && item.tags.length > 0) {
            popupContent += `<p class="mb-1"><strong>Tags:</strong> ${item.tags.join(', ')}</p>`;
        }
        
        if (item.thumbnail) {
            popupContent += `<img src="${item.thumbnail}" style="max-width: 200px; margin-top: 10px; border-radius: 4px;">`;
        }
        
        popupContent += `</div>`;
        
        marker.bindPopup(popupContent);
        markers.addLayer(marker);
    });
    
    map.addLayer(markers);
    
    // If URL has lat/lon params, center map there
    const urlParams = new URLSearchParams(window.location.search);
    const lat = urlParams.get('lat');
    const lon = urlParams.get('lon');
    if (lat && lon) {
        map.setView([parseFloat(lat), parseFloat(lon)], 15);
    }
</script>
{% endblock %}
