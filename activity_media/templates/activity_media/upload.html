{% extends 'activity_media/base.html' %}
{% load static %}

{% block title %}Upload Media - Media Gallery{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <h1 class="mb-4">Upload Media</h1>
        
        <form method="post" enctype="multipart/form-data" id="upload-form">
            {% csrf_token %}
            
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">Upload Photo or Video</h5>
                    {{ form.media_type }}
                    <div class="mb-3">
                        <label for="{{ form.file.id_for_label }}" class="form-label">Select File *</label>
                        {{ form.file }}
                        {% if form.file.errors %}
                            <div class="text-danger">{{ form.file.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">
                            üì∑ Photos: JPG, PNG, GIF, WEBP | üé• Videos: MP4, MOV, AVI, MKV (Max 100MB)<br>
                            <em>File type will be automatically detected</em>
                        </small>
                    </div>
                </div>
            </div>
            
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">Details</h5>
                    <div class="mb-3">
                        <label for="{{ form.title.id_for_label }}" class="form-label">Title</label>
                        {{ form.title }}
                        {% if form.title.errors %}
                            <div class="text-danger">{{ form.title.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="text-danger">{{ form.description.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">Location</h5>
                    <p class="text-muted">Optional: Add location to map your media</p>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.latitude.id_for_label }}" class="form-label">Latitude</label>
                            {{ form.latitude }}
                            {% if form.latitude.errors %}
                                <div class="text-danger">{{ form.latitude.errors }}</div>
                            {% endif %}
                            <small class="form-text text-muted">Leave blank to auto-extract from photo metadata (if available)</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.longitude.id_for_label }}" class="form-label">Longitude</label>
                            {{ form.longitude }}
                            {% if form.longitude.errors %}
                                <div class="text-danger">{{ form.longitude.errors }}</div>
                            {% endif %}
                            <small class="form-text text-muted">Leave blank to auto-extract from photo metadata (if available)</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-outline-primary" id="get-location-btn">
                            üìç Use Current Location
                        </button>
                        <small class="text-muted ms-2">Click to automatically fill your current location</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.location_name.id_for_label }}" class="form-label">Location Name/Address</label>
                        {{ form.location_name }}
                        {% if form.location_name.errors %}
                            <div class="text-danger">{{ form.location_name.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div id="location-map" style="height: 300px; width: 100%; margin-top: 15px; border: 1px solid #ddd; border-radius: 4px; display: none;"></div>
                </div>
            </div>
            
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">Activity Tags</h5>
                    
                    <!-- Create new tags -->
                    <div class="mb-3">
                        <label for="{{ form.activity_tags_input.id_for_label }}" class="form-label">Create New Tags</label>
                        {{ form.activity_tags_input }}
                        <small class="form-text text-muted">{{ form.activity_tags_input.help_text }}</small>
                        {% if form.activity_tags_input.errors %}
                            <div class="text-danger">{{ form.activity_tags_input.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <!-- Select existing tags -->
                    <div class="mb-3">
                        <label class="form-label">Or Select Existing Tags</label>
                        {% if form.activity_tags.field.queryset.exists %}
                            <div class="row">
                                {% for tag in form.activity_tags %}
                                    <div class="col-md-4 mb-2">
                                        <div class="form-check">
                                            {{ tag }}
                                            <label class="form-check-label" for="{{ tag.id_for_label }}">
                                                {{ tag.choice_label }}
                                            </label>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                <small>No activity tags exist yet. Create new tags using the field above.</small>
                            </div>
                        {% endif %}
                        {% if form.activity_tags.errors %}
                            <div class="text-danger">{{ form.activity_tags.errors }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="card mb-3">
                <div class="card-body">
                    <div class="form-check">
                        {{ form.is_public }}
                        <label class="form-check-label" for="{{ form.is_public.id_for_label }}">
                            Make this media public (visible to all users)
                        </label>
                    </div>
                    {% if form.is_public.errors %}
                        <div class="text-danger">{{ form.is_public.errors }}</div>
                    {% endif %}
                </div>
            </div>
            
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary btn-lg">Upload Media</button>
                <a href="{% url 'activity_media:list' %}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Get current location
    document.getElementById('get-location-btn').addEventListener('click', function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                document.getElementById('{{ form.latitude.id_for_label }}').value = position.coords.latitude.toFixed(6);
                document.getElementById('{{ form.longitude.id_for_label }}').value = position.coords.longitude.toFixed(6);
                
                // Show map with marker
                const mapDiv = document.getElementById('location-map');
                mapDiv.style.display = 'block';
                
                if (!window.locationMap) {
                    window.locationMap = L.map('location-map').setView([position.coords.latitude, position.coords.longitude], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors'
                    }).addTo(window.locationMap);
                } else {
                    window.locationMap.setView([position.coords.latitude, position.coords.longitude], 13);
                }
                
                // Add/update marker
                if (window.locationMarker) {
                    window.locationMarker.setLatLng([position.coords.latitude, position.coords.longitude]);
                } else {
                    window.locationMarker = L.marker([position.coords.latitude, position.coords.longitude])
                        .addTo(window.locationMap)
                        .bindPopup('Your location');
                }
            }, function(error) {
                alert('Unable to get your location: ' + error.message);
            });
        } else {
            alert('Geolocation is not supported by your browser.');
        }
    });
</script>
{% endblock %}
